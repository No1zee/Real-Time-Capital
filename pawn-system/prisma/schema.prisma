generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums (Postgres supports these natively)
enum UserRole {
  CUSTOMER
  STAFF
  ADMIN
  SUPER_ADMIN
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum UserTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  HOLD
  PAYMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REJECTED
}

enum TransactionMethod {
  CASH
  ECOCASH
  ZIPIT
  SYSTEM
}

enum LoanStatus {
  PENDING
  APPROVED
  ACTIVE
  COMPLETED
  DEFAULTED
}

enum ItemStatus {
  PENDING_VALUATION
  VALUED
  PAWNED
  IN_AUCTION
  SOLD
  REDEEMED
}

enum AuctionStatus {
  SCHEDULED
  ACTIVE
  ENDED
  CANCELLED
}

enum DisputeStatus {
  OPEN
  RESOLVED
  CLOSED
}

enum NotificationType {
  OUTBID
  AUCTION_WON
  AUCTION_LOST
  SYSTEM
  LOAN_OFFER
  LOAN_UPDATE
  PAYMENT_REMINDER
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Auction {
  id         String      @id
  itemId     String      @unique
  startPrice Decimal
  currentBid Decimal?
  startTime  DateTime
  endTime    DateTime
  status     AuctionStatus      @default(SCHEDULED)
  isPractice Boolean     @default(false)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime
  Item       Item        @relation(fields: [itemId], references: [id])
  AutoBid    AutoBid[]
  Bid        Bid[]
  Dispute    Dispute[]
  Rating     Rating?
  Watchlist  Watchlist[]
}

model AutoBid {
  id        String   @id
  userId    String
  auctionId String
  maxAmount Decimal
  createdAt DateTime @default(now())
  updatedAt DateTime
  Auction   Auction  @relation(fields: [auctionId], references: [id])
  User      User     @relation(fields: [userId], references: [id])

  @@unique([userId, auctionId])
}

model Bid {
  id        String   @id
  auctionId String
  userId    String
  amount    Decimal
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])
  Auction   Auction  @relation(fields: [auctionId], references: [id])
}

model Customer {
  id          String   @id
  firstName   String
  lastName    String
  nationalId  String   @unique
  phoneNumber String
  email       String?
  address     String?
  creditScore Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Loan        Loan[]
}

model Dispute {
  id          String   @id
  userId      String
  auctionId   String
  reason      String
  description String
  status      DisputeStatus   @default(OPEN)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Auction     Auction  @relation(fields: [auctionId], references: [id])
  User        User     @relation(fields: [userId], references: [id])
}

model Item {
  id           String    @id
  loanId       String?
  name         String
  category     String    @default("Other")
  brand        String?
  model        String?
  description  String
  serialNumber String?
  valuation    Decimal
  status       ItemStatus    @default(PENDING_VALUATION)
  location     String?
  images       String    @default("[]")
  valuationDetails String?
  salePrice    Decimal?
  soldAt       DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  userId       String?
  User         User?     @relation(fields: [userId], references: [id])
  Auction      Auction?
  Loan         Loan?     @relation(fields: [loanId], references: [id])
}

model Loan {
  id              String    @id @default(cuid())
  userId          String?
  customerId      String?
  principalAmount Decimal
  interestRate    Decimal
  durationDays    Int
  startDate       DateTime  @default(now())
  dueDate         DateTime
  status          LoanStatus    @default(PENDING)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  Item            Item[]
  User            User?     @relation(fields: [userId], references: [id])
  Customer        Customer? @relation(fields: [customerId], references: [id])
  Payment         Payment[]
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      NotificationType   @default(SYSTEM)
  title     String   @default("Notification")
  message   String
  link      String?
  isRead    Boolean  @default(false)
  auctionId String?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])
}

model Payment {
  id        String   @id @default(cuid())
  loanId    String
  amount    Decimal
  date      DateTime @default(now())
  method    String
  reference String?
  createdAt DateTime @default(now())
  Loan      Loan     @relation(fields: [loanId], references: [id])
}

model Rating {
  id        String   @id @default(cuid())
  userId    String
  auctionId String   @unique
  score     Int
  comment   String?
  createdAt DateTime @default(now())
  Auction   Auction  @relation(fields: [auctionId], references: [id])
  User      User     @relation(fields: [userId], references: [id])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Transaction {
  id             String   @id @default(cuid())
  userId         String
  amount         Decimal
  type           TransactionType
  status         TransactionStatus   @default(PENDING)
  method         TransactionMethod
  reference      String?
  proofOfPayment String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  User           User     @relation(fields: [userId], references: [id])
}

model User {
  id                 String         @id @default(cuid())
  name               String?
  email              String?        @unique
  emailVerified      DateTime?
  image              String?
  password           String?
  role               UserRole         @default(CUSTOMER)
  tier               UserTier         @default(BRONZE)
  verificationStatus VerificationStatus         @default(UNVERIFIED)
  idImage            String?
  verificationNote   String?
  isActive           Boolean        @default(true)
  permissions        String         @default("") // SQLite doesn't support arrays, use comma-separated string
  walletBalance      Decimal        @default(0)
  practiceBalance    Decimal        @default(50000)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  Account            Account[]
  AutoBid            AutoBid[]
  Bid                Bid[]
  Dispute            Dispute[]
  Notification       Notification[]
  Rating             Rating[]
  Session            Session[]
  Transaction        Transaction[]
  Watchlist          Watchlist[]
  Item               Item[]
  Loan               Loan[]
  AuditLog           AuditLog[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Watchlist {
  id        String   @id @default(cuid())
  userId    String
  auctionId String
  createdAt DateTime @default(now())
  Auction   Auction  @relation(fields: [auctionId], references: [id])
  User      User     @relation(fields: [userId], references: [id])

  @@unique([userId, auctionId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  entityType String
  entityId   String?
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}
