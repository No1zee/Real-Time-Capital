generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums (Postgres supports these natively)
enum UserRole {
  CUSTOMER
  STAFF
  ADMIN
  SUPER_ADMIN
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum UserTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  HOLD
  PAYMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REJECTED
}

enum TransactionMethod {
  CASH
  ECOCASH
  ZIPIT
  SYSTEM
}

enum LoanStatus {
  PENDING
  APPROVED
  ACTIVE
  COMPLETED
  DEFAULTED
}

enum ItemStatus {
  PENDING_VALUATION
  VALUED
  PAWNED
  IN_AUCTION
  SOLD
  REDEEMED
}

enum AuctionStatus {
  SCHEDULED
  ACTIVE
  ENDED
  CANCELLED
}

enum DisputeStatus {
  OPEN
  RESOLVED
  CLOSED
}

enum NotificationType {
  OUTBID
  AUCTION_WON
  AUCTION_LOST
  SYSTEM
  LOAN_OFFER
  LOAN_UPDATE
  PAYMENT_REMINDER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketCategory {
  LOAN_INQUIRY
  VALUATION
  PAYMENT_ISSUE
  ACCOUNT
  OTHER
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum SenderType {
  USER
  SUPPORT
}

enum AuctionType {
  ONLINE
  LIVE
  SEALED
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Auction {
  id         String      @id @default(cuid())
  itemId     String      @unique
  startPrice Decimal
  currentBid Decimal?
  reservePrice Decimal?
  startTime  DateTime
  endTime    DateTime
  type       AuctionType        @default(ONLINE)
  status     AuctionStatus      @default(SCHEDULED)
  isPractice Boolean     @default(false)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime
  Item       Item        @relation(fields: [itemId], references: [id])
  AutoBid    AutoBid[]
  Bid        Bid[]
  Dispute    Dispute[]
  Rating     Rating?
  Watchlist  Watchlist[]
  
  // Auction Logic Extensions
  extendedCount   Int     @default(0)
  allowAutoExtend Boolean @default(true)
  buyerLevyPercent Float  @default(15.0)
  vatPercent       Float  @default(15.0)
  
  // Trade Me Features
  buyNowPrice      Decimal?
  Questions        Question[]
  
  winnerId         String?
  Winner           User?       @relation("AuctionWins", fields: [winnerId], references: [id])
}

model AutoBid {
  id        String   @id @default(cuid())
  userId    String
  auctionId String
  maxAmount Decimal
  createdAt DateTime @default(now())
  updatedAt DateTime
  Auction   Auction  @relation(fields: [auctionId], references: [id])
  User      User     @relation(fields: [userId], references: [id])

  @@unique([userId, auctionId])
}

model Bid {
  id        String   @id @default(cuid())
  auctionId String
  userId    String
  amount    Decimal
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])
  Auction   Auction  @relation(fields: [auctionId], references: [id])
}

model Customer {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  nationalId  String   @unique
  phoneNumber String
  email       String?
  address     String?
  creditScore Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Loan        Loan[]
}

model Dispute {
  id          String   @id @default(cuid())
  userId      String
  auctionId   String
  reason      String
  description String
  status      DisputeStatus   @default(OPEN)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Auction     Auction  @relation(fields: [auctionId], references: [id])
  User        User     @relation(fields: [userId], references: [id])
}

enum AssetType {
  JEWELRY
  ELECTRONICS
  VEHICLE
  COLLECTIBLE
  FURNITURE
  PROPERTY
  GOODS
  OTHER
}

enum ItemCondition {
  NEW
  LIKE_NEW
  USED
  DAMAGED
}

enum ValuationStatus {
  PENDING
  PENDING_MARKET_EVAL
  MARKET_EVAL_COMPLETE
  PENDING_FINAL_OFFER
  PENDING_APPROVAL
  OFFER_READY
  OFFER_ACCEPTED
  REJECTED
  REJECTED_BY_CHECKER
}

model Item {
  id           String    @id @default(cuid())
  loanId       String?
  
  // Core Details
  name         String
  category     AssetType    @default(OTHER)
  type         String?      // Keeping for backward compatibility or subtype
  brand        String?
  model        String?
  description  String
  serialNumber String?
  condition    ItemCondition @default(USED)
  yearOfPurchase Int?
  
  // Vehicle Specifics
  vin                String?
  engineNumber       String?
  chassisNumber      String?
  registrationNumber String?
  mileage            Int?
  color              String?
  
  // IAAI Style Condition Report
  primaryDamage      String?
  secondaryDamage    String?
  hasKeys            Boolean?
  runsAndDrives      Boolean?
  
  // Jewelry/Other Specifics
  purity             String? // Karat
  weight             Decimal? // Grams/Carats
  dimensions         String?
  provenance         String? // For collectibles
  
  // Valuation Workflow
  userEstimatedValue Decimal?
  marketValue        Decimal?
  finalValuation     Decimal? // The offer amount
  valuationStatus    ValuationStatus @default(PENDING)
  valuation          Decimal // Keeping original field for now, might migrate to finalValuation
  
  status       ItemStatus    @default(PENDING_VALUATION)
  location     String?
  images       String    @default("[]")
  valuationDetails String?
  
  salePrice    Decimal?
  soldAt       DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  
  userId       String?
  User         User?     @relation(fields: [userId], references: [id])
  Auction      Auction?
  Loan         Loan?     @relation(fields: [loanId], references: [id])
  
  // Maker Checker
  makerId      String?
  checkerId    String?
  checkedAt    DateTime?
  rejectionReason String?
  Maker        User?     @relation("ItemMaker", fields: [makerId], references: [id])
  Checker      User?     @relation("ItemChecker", fields: [checkerId], references: [id])
}

model Loan {
  id              String    @id @default(cuid())
  userId          String?
  customerId      String?
  principalAmount Decimal
  interestRate    Decimal
  durationDays    Int
  startDate       DateTime  @default(now())
  dueDate         DateTime
  status          LoanStatus    @default(PENDING)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  signatureUrl    String?
  ticketRef       String?   @unique
  storageFee      Decimal   @default(0)
  adminFee        Decimal   @default(0)
  termsAccepted   Boolean   @default(false)
  Item            Item[]
  User            User?     @relation(fields: [userId], references: [id])
  Customer        Customer? @relation(fields: [customerId], references: [id])
  Payment         Payment[]
  
  // Maker Checker
  makerId         String?
  checkerId       String?
  checkedAt       DateTime?
  Maker           User?     @relation("LoanMaker", fields: [makerId], references: [id])
  Checker         User?     @relation("LoanChecker", fields: [checkerId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      NotificationType   @default(SYSTEM)
  title     String   @default("Notification")
  message   String
  link      String?
  isRead    Boolean  @default(false)
  auctionId String?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])
}

model Payment {
  id        String   @id @default(cuid())
  loanId    String
  amount    Decimal
  date      DateTime @default(now())
  method    String
  reference String // e.g. "LOAN-123"
  description String?
  createdAt DateTime @default(now())
  Loan      Loan     @relation(fields: [loanId], references: [id])
}



model Rating {
  id        String   @id @default(cuid())
  userId    String
  auctionId String   @unique
  score     Int
  comment   String?
  createdAt DateTime @default(now())
  Auction   Auction  @relation(fields: [auctionId], references: [id])
  User      User     @relation(fields: [userId], references: [id])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Transaction {
  id             String   @id @default(cuid())
  userId         String
  amount         Decimal
  type           TransactionType
  status         TransactionStatus   @default(PENDING)
  method         TransactionMethod
  reference      String?
  proofOfPayment String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  User           User     @relation(fields: [userId], references: [id])
}

model User {
  id                 String         @id @default(cuid())
  name               String?
  email              String?        @unique
  phoneNumber        String?        @unique
  nationalId         String?        @unique
  address            String?
  location           String?
  dateOfBirth        DateTime?
  termsAccepted      Boolean        @default(false)
  emailVerified      DateTime?
  image              String?
  password           String?
  passwordLastSet    DateTime?      @default(now())
  role               UserRole         @default(CUSTOMER)
  tier               UserTier         @default(BRONZE)
  verificationStatus VerificationStatus         @default(UNVERIFIED)
  idImage            String?
  verificationNote   String?
  isActive           Boolean        @default(true)
  permissions        String         @default("") // SQLite doesn't support arrays, use comma-separated string
  walletBalance      Decimal        @default(0)
  auctionDeposit     Decimal        @default(0)
  practiceBalance    Decimal        @default(50000)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  Account            Account[]
  AutoBid            AutoBid[]
  Bid                Bid[]
  Dispute            Dispute[]
  Notification       Notification[]
  Rating             Rating[]
  Session            Session[]
  Transaction        Transaction[]
  Watchlist          Watchlist[]
  Item               Item[]
  Loan               Loan[]

  AuditLog           AuditLog[]
  Ticket             Ticket[]
  Article            Article[]
  UserPattern        UserPattern[]
  Questions          Question[]

  // CRM Relations
  NotesReceived      CRMNote[]     @relation("NotesReceived")
  NotesWritten       CRMNote[]     @relation("NotesAuthored")
  TasksAssigned      CRMTask[]     @relation("TaskAssignee")
  TasksAbout         CRMTask[]     @relation("TaskSubject")
  LogsAbout          CRMLog[]      @relation("LogSubject")
  LogsRecorded       CRMLog[]      @relation("LogAuthor")
  Documents          UserDocument[]
  Tags               UserCRMTag[]
  
  // Auction Relations
  Wins               Auction[]     @relation("AuctionWins")
  
  // Maker Checker Relations
  ItemsMade          Item[]        @relation("ItemMaker")
  ItemsChecked       Item[]        @relation("ItemChecker")
  LoansMade          Loan[]        @relation("LoanMaker")
  LoansChecked       Loan[]        @relation("LoanChecker")
}

model CRMNote {
  id        String   @id @default(cuid())
  userId    String
  authorId  String
  content   String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  User      User     @relation("NotesReceived", fields: [userId], references: [id])
  Author    User     @relation("NotesAuthored", fields: [authorId], references: [id])
}

model CRMTask {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  dueDate     DateTime?
  
  assigneeId  String?
  userId      String   // The client this task is about
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  Assignee    User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])
  User        User     @relation("TaskSubject", fields: [userId], references: [id])
}

model CRMLog {
  id        String   @id @default(cuid())
  type      String   // CALL, EMAIL, MEETING, NOTE_LOG
  summary   String
  details   String?  @db.Text
  date      DateTime @default(now())
  
  userId    String   // Client
  authorId  String   // Staff
  
  User      User     @relation("LogSubject", fields: [userId], references: [id])
  Author    User     @relation("LogAuthor", fields: [authorId], references: [id])
}

model CRMTag {
  id        String       @id @default(cuid())
  name      String       @unique
  color     String       @default("gray")
  users     UserCRMTag[]
}

model UserCRMTag {
  userId    String
  tagId     String
  user      User     @relation(fields: [userId], references: [id])
  tag       CRMTag   @relation(fields: [tagId], references: [id])
  
  @@id([userId, tagId])
}

model UserDocument {
  id          String   @id @default(cuid())
  userId      String
  title       String
  url         String
  type        String   // ID, PROOF_RES, CONTRACT, OTHER
  status      String   @default("PENDING") // PENDING, VERIFIED, REJECTED
  uploadedAt  DateTime @default(now())
  
  User        User     @relation(fields: [userId], references: [id])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Watchlist {
  id        String   @id @default(cuid())
  userId    String
  auctionId String
  createdAt DateTime @default(now())
  Auction   Auction  @relation(fields: [auctionId], references: [id])
  User      User     @relation(fields: [userId], references: [id])

  @@unique([userId, auctionId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  entityType String
  entityId   String?
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}

model Ticket {
  id          String         @id @default(cuid())
  userId      String
  subject     String
  category    TicketCategory
  description String
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  User     User            @relation(fields: [userId], references: [id])
  Messages TicketMessage[]
}

model TicketMessage {
  id        String     @id @default(cuid())
  ticketId  String
  sender    SenderType
  message   String
  timestamp DateTime   @default(now())

  Ticket Ticket @relation(fields: [ticketId], references: [id])
}

model Article {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?
  content     String   @db.Text
  category    String
  coverImage  String?
  published   Boolean  @default(false)
  authorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  Author User @relation(fields: [authorId], references: [id])
}

model UserPattern {
  id        String   @id @default(cuid())
  userId    String
  type      String   // CLICK, VIEW, BID, LIKE
  target    String   // e.g., "/portal/jewelry", "BID_BUTTON"
  count     Int      @default(1)
  lastAt    DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id])

  @@unique([userId, type, target])
}

model Question {
  id        String   @id @default(cuid())
  text      String
  answer    String?
  userId    String
  auctionId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  User      User     @relation(fields: [userId], references: [id])
  Auction   Auction  @relation(fields: [auctionId], references: [id])
}
